---
permalink: /update-to-latest_old.html
title: Безопасное обновление прошивки вручную
author_profile: true
---
{% include toc title="Разделы" %}

Для удобства использования взлома в данный момент лучшим решением будет обновить прошивку до актуальной - {% include /vars/sys_version.txt %}. Однако, если ваша прошивка была ниже, чем 5.0.0. то обновившись вы рискуете остаться без колдбута, который, возможно, когда-нибудь нам подарят авторы атмосферы. Наиболее правильным решением в такой ситуации будет обновление с возможностью даунгрейда. 

В обычном режиме при установке прошивки, консоль проверяет количество сожжённых предохранителей. Если это количество больше, чем требуется для прошивки, то консоль понимает, что вы пытаетесь установить прошивку ниже, чем была установлена до этого и не позволит это сделать. Если же количество сожжённых предохранителей ниже, чем требует устанавливаемая прошивка, то прошивка разрешается и в ходе неё сжигается столько предохранителей сколько необходимо, чтобы соответствовать указанному в прошивке количеству. Таким образом вы не можете восстановить бекап своей старой прошивки, если её версия ниже, чем текущая. 

Однако, все это можно обойти. 

Обязательно сделайте резервную копию всех сохранений и важных данных, если таковые имеются, с помощью [Homebrew Launcher](launch-hbl){:target="_blank"} и соответствующей программы!

# Что понадобится

* Включите [отображение расширений файлов](file-extensions-windows){:target="_blank"}, если у вас Windows
* Умение [запускать пейлоады через Fusée Gelée](fusee-gelee){:target="_blank"}
* Приставка должна быть полностью заряжена!
* Свежая версия пейлоада {% include inc/hekate.txt %}
* [Ключи](/files/keys.zip){:target="_blank"}, одинаковые для всех консолей
* Прошивка 5.1.0:
	* [ЯД](https://yadi.sk/d/F1jy8lin3Z2fgQ){:target="_blank"}
	* [MEGA](https://mega.nz/#!Eg1ByBpK!ihVJklLwGoj6XgpmPhhEMKTnEzUVbUWPoVZah7lKIz8){:target="_blank"}
	* [FEX](https://fex.net/674993139076?fileId=586334025){:target="_blank"}
* Свежая версия [ChoiDujour](https://switchtools.sshnuke.net/){:target="_blank"}
* Свежая версия [memloader](https://switchtools.sshnuke.net/){:target="_blank"}
* Свежая версия [briccmii](https://switchtools.sshnuke.net/){:target="_blank"}
* Свежая версия [Etcher](https://github.com/resin-io/etcher/releases/latest){:target="_blank"} для вашей платформы (для Windows - **exe x86**)
* Свежая версия [HacDiskMount](https://switchtools.sshnuke.net/){:target="_blank"}

# Инструкция

## Часть I - Резервное копирование NAND

Этот пункт нужно делать **обязательно**! Для продолжения работы нам понадобятся уникальные ключи именно вашей приставки! Без шуток! Вероятность, что что-то пойдт не так много выше нуля, без бекапа вы ничего не сможете исправить. 
{: .notice--danger}

1. Создайте [резервную копию NAND](backup-nand){:target="_blank"} консоли и поместите её в надёжное место 

## Часть II - Проверка количества сожжённых предохранителей

1. Запустите пейлоад {% include inc/hekate.txt %} с помощью [Fusée Gelée](fusee-gelee){:target="_blank"}

	Для перемещения по меню, hekata используйте клавиши (VOL-) и (VOL+), для выбора - (POWER)
	{: .notice--info}

1. Перейдите в меню "Console info..." -> "Print fuse info"
1. Запомните или запишите число напротив строки "Burnt fuses" - оно и будет означать количество сожжённых предохранителей. 
	* 1 сгоревший соответствуют прошивке 1.0.0
	* 2 сгоревших соответствуют прошивке 2.0.0-2.3.0
	* 3 сгоревших соответствуют прошивке 3.0.0
	* 4 сгоревших соответствуют прошивке 3.0.1-3.0.2
	* 5 сгоревших соответствуют прошивке 4.0.0-4.1.0
	* 6 сгоревших соответствуют прошивке 5.х.х
1. Нажмите любую кнопку для выхода в меню
1. Выберите "Back", чтобы вернуться в главное меню

## Часть III - Перепаковка прошивки под вашу систему

1. Распакуйте `.zip-архив` с [ChoiDujour](https://switchtools.sshnuke.net/){:target="_blank"} в удобную папку
1. Распакуйте `.zip-архив` с ключами в папку `ChoiDujour` таким образом, чтобы файл `keys.txt` лежал в той же директории, что и `ChoiDujour.exe`
1. Распакуйте `.zip-архив` с прошивкой 5.1.0 в папку `ChoiDujour` таким образом, чтобы папка `510` лежала в той же директории, что и `ChoiDujour.exe`
1. Откройте файлы `keys.txt` и `biskeys.txt`, который у вас получился в ходе выполнения "Части I"
1. Скопируйте значение строки "SBK" из файла `biskeys.txt` вместо `XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX` в поле "secure_boot_key" в файле `keys.txt`
1. Скопируйте значение строки "TSEC KEY" из файла `biskeys.txt` вместо `XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX` в поле "tsec_key" в файле `keys.txt`

	![]({{ base_path }}/images/screenshots/keys.png) 
	{: .text-center}
	{: .notice--info}

1. Запустите командную строку в папке `ChoiDujour` (вызовите контекстное меню с зажатой клавишей Shift, нажав на свободное место в папке, и выберите "Открыть Командную строку здесь" или "Открыть окно PowerShell здесь")
1. В открывшемся окне наберите:
	* Для powershell: `.\ChoiDujour.exe --keyset=keys.txt 510`
	* Для командной строки: `ChoiDujour.exe --keyset=keys.txt 510`
1. Дождитесь окончания перепаковки. В результате вы получите папку NX-5.1.0

## Часть IV - Подготовка карты памяти

{% capture notice-6 %}   
**ВНИМАНИЕ!!!** Если вы в процессе выполнения руководства увидите диалоговое окно, с предложением отформатировать диск - **нажмите отмена**!!

![]({{ base_path }}/images/screenshots/format.png) 
{: .text-center}
{% endcapture %}
<div class="notice--danger">{{ notice-6 | markdownify }}</div>

1. Выключите консоль
1. Вставьте карту памяти приставки в ПК
1. Убедитесь, что включили [отображение расширений файлов](file-extensions-windows){:target="_blank"}, если у вас Windows
1. Скопируйте **содержимое** папки `sample` из `.zip`-архива с [memloader](https://switchtools.sshnuke.net/){:target="_blank"} в **корень** вашей карты памяти
1. Верните карту памяти обратно в Switch
1. Скопируйте пейлоад `memloader.bin` в папку из которой передаёте их на Switch

## Часть VI - Загрузка прошивки на устройство 

{% include inc/mount_boot.txt

	boot="BOOT0" 

%}

{% include inc/inject_boot.txt 

	boot="0" 

%}

{% include inc/mount_boot.txt 

	boot="BOOT1" 

%}

{% include inc/inject_boot.txt 

	boot="1" 

%}

{% include inc/mount_boot.txt 

	boot="eMMC" 

%}

### Настройка eMMC через HacDiskMount

1. Распакуйте [HacDiskMount](https://switchtools.sshnuke.net/){:target="_blank"} в удобную папку
1. Запустите `HacDiskMount.exe` от имени администратора 
1. Выберите  "File" -> "Open Physical"
1. Выберите `UMS Linux Disk 0 (29.121GiB)`
1. Вы увидите полный список разделов, содержащихся в этом диске

	![]({{ base_path }}/images/screenshots/hdm_disk.png) 
	{: .text-center}
	{: .notice--info}
	
1. Дважды нажмите на `PRODINFO`
1. Откройте файл `biskeys.txt`, который мы получили при создании дампа ключей в Части I
1. В разделе "BIS Key 0" есть два поля - "Crypto" и "Tweak". В файле с ключами ключи делятся попарно. В каждой паре есть так же ключ с меткой "Crypto" (crypt) и "Tweak" (tweak). 

	![]({{ base_path }}/images/screenshots/hdm_key_test.png) 
	{: .text-center}
	{: .notice--info}
	
1. Скопируйте ключи соответственно их меткам  из текстового файла `biskeys.txt` в окно программы и нажмите кнопку "Test"
1. Рядом с кнопкой высветится надпись зелёного цвета (OK! Enthropy: (tested)), то люч скопирован верно - нажмите кнопку "Save" и закройте окно (не программу!)
	* Если после тестирования надпись красная - вы скопировали не верную пару!
1. Повторите ту же самую процедуру для разделов `SAFE`, `SYSTEM` и `USER`, прописав им пары "BIS KEY 1", "BIS KEY 2" и "BIS KEY 3" соответственно 
	* Обращайте внимание на результат тестирования и не забывайте нажимать кнопку "Save"
1. Дважды нажмите на `PRODINFO`
1. В открывшемся окошке уже будут вбиты ключи. Протестируйте их и удостоверьтесь, что результат зелёный. Закройте окно не сохраняя.

### Перенос образов BCPKG2 

1. Дважды нажмите на `BCPKG2-1-Normal-Main`
1. Убедитесь, что поля для ключей пустые. Если это не так, отчистите их
1. В секции "Restore from file" нажмите "Browse"

	![]({{ base_path }}/images/screenshots/hdm_bcpkg21-nm.png) 
	{: .text-center}
	{: .notice--info}

1. Выберите `BCPKG2-1-Normal-Main.bin`, который находится в папке `NX-5.1.0`, которую мы сгенерировали в Части III 
1. Нажмите кнопку "Start"
1. После окончания загрузки закройте окно (не программу!)
1. Повторите то же самое для `BCPKG2-2-Normal-Sub`, `BCPKG2-3-SafeMode-Main` и `BCPKG2-4-SafeMode-Sub`
	* Убедитесь, что прошиваете файлы с названиями, идентичными названиям разделов!
	* Не забывайте стирать ключи, если таковые будут

### Удаление файлов из раздела SAFE 

{% include inc/mount.txt 

	mount="SAFE" 

%}
1. Если на диске есть файлы - удалите их все!
1. После окончания отмонтируйте диск, нажав на кнопку "Unmount" в окне HacDiskMount

### Монтирование раздела SYSTEM

{% include inc/mount.txt 

	mount="SYSTEM" 

%}

#### Выберите один из методов: 

##### Метод 1 - Полная инициализация системы

Пойдя этим путём вы удалите все данные из консоли, включая аккаунты, игры и сохранения. Однако этот путь более безопасный и не приведёт к проблемам в дальнейшем

1. Выделите все файлы на диске и удалите их!

##### Метод 2 - Сохранение настроек

Это экспериментальный метод! Он может не сработать при попытке в дальнейшем понизить прошивку!

1. Удалите папку "Content"
1. Удалите "PRF2SAFE.RCV", если таковой имеется
1. Перейдите в папку `save` и удалите файл `8000000000000047`

### Копирование файлов в раздел SYSTEM

1. Перейдите в папку `NX-5.1.0`, которую мы сгенерировали в Части III и скопируйте всё **содержимое** папки `SYSTEM` на смонтированный диск с заменой
1. После окончания копирования отмонтируйте диск, нажав на кнопку "Unmount" в окне HacDiskMount

### Монтирование раздела USER

{% include inc/mount.txt 

	mount="USER" 

%}

#### Выберите один из методов: 

##### Метод 1 - Полная инициализация системы

Пойдя этим путём вы удалите все данные из консоли, включая аккаунты, игры и сохранения. Однако этот путь более безопасный и не приведёт к проблемам в дальнейшем

1. Выделите все файлы на диске и удалите их!

##### Метод 2 - Сохранение настроек

1. Удалите "PRF2SAFE.RCV", если таковой имеется

### Копирование файлов в раздел USER

1. Перейдите в папку `NX-5.1.0`, которую мы сгенерировали в Части III и скопируйте всё **содержимое** папки `USER` на смонтированный диск с заменой
1. После окончания копирования отмонтируйте диск, нажав на кнопку "Unmount" в окне HacDiskMount
1. Закройте HacDiskMount
1. Выключите Switch, зажав кнопку (POWER) на 15 секунд, пока подсветка экрана не отключится

## Часть VII - Первый запуск 

Теперь при каждом запуске **название-кастома nogc patch** у вас будет запускаться кастомная прошивка, чистится логи, отключается проверка подписи и патчится системный модуль, позволяющий не обновлять прошивку слота для картриджей. Если вы захотите запустить другую конфигурацию hekate, не забудьте добавить строку `kip1=kip1patch=nogc,nosigchk` в конфиг. Помните, что запуск другой прошивки без этого модуля приведут к обновлению прошивки слота и при даунгрейде на прошивку ниже, чем 4.0.0 он перестанет работать! Это значит, что слот не будет работать ТОЛЬКО на прошивке ниже, чем 4.0.0. На любой прошивке выше он будет работать в обычном режиме! 
{: .notice--warning}

Обратите внимание, что при выборе **название-кастома with nogc patch** у вас перестанет работать слот картриджа на прошивке 5.1.0. Это не ошибка, это сделано намеренно, чтобы не дать прошивке слота вашего картриджа обновиться! 

Теперь приставка должна находится на последней версии прошивки, поддерживать exFAT и сохранить предохранители. Теперь можете отформатировать карту памяти в exFAT.
{: .notice--warning}

# Предупреждения

* Если вы будете заменять файл `rajnx_ipl.ini` на другой, не забудьте [прописать строчку](#подготовительные-работы){:target="_blank"} `kip1patch=nogc,nosigchk` в конфиг
* При обновлении прошивки AutoRCM слетает 
* При установке драйвера exFAT AutoRCM слетает 
* Даже один единственный запуск приставки в официальную прошивку не через hekate сожжёт предохранители, которые мы так отчаянно пытались сохранить 

# Зачем нужна NOGC 

Если вы обновились с прошивки индекс которой строго ниже, чем 4.0.0 на прошивку выше, чем 4.0.0, включительно, то после обновления, при первом же запуске прошивки, вы так же обновите прошивку и слота для картриджей. Это приведёт к тому, что захоти вы вернуться на первоначальную прошивку, вы лишитесь возможности использовать слот для картриджей. Нужен ли он вам будет - это вопрос. Поэтому, если вы обновлялись с прошивки строго ниже, чем 4.0.0 и у вас нет картриджей, которые бы вы могли использовать, не отключайте NOGC. В остальных случаях - на ваше усмотрение. Еще раз - NOGC нужен только тем пользователям, что выполнял безопасное обновление с прошивки строго ниже, чем 4.0.0!

___

# Следующий шаг: [Запуск кастомной прошивки](launch-cfw) 
{: .notice--success}